/**
  ******************************************************************************
  * @file    bsp_rtc.c
  * @version V1.0
  * @date    2013-xx-xx
  * @brief   stm32 RTC ????
  ******************************************************************************
  * @attention
  *
  * ?????:??? F103-????? STM32 ?????? 
  * ???    :http://www.firebbs.cn
  * ???    :https://fire-stm32.taobao.com
  *
  ******************************************************************************
  */ 
#include "bsp_usart.h"
#include "bsp_rtc.h"

#include "printf.h"

/* ???��????????????��????1???????????????0 */
__IO uint32_t TimeDisplay = 0;

/*???????��??????ASCII??*/
char const *WEEK_STR[] = {"??", "?", "??", "??", "??", "??", "??"};
char const *zodiac_sign[] = {"??", "??", "?", "??", "??", "??", "??", "??", "??", "??", "??", "??"};

/*???????????��??????ASCII??*/
char const *en_WEEK_STR[] = { "Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
char const *en_zodiac_sign[] = {"Pig", "Rat", "Ox", "Tiger", "Rabbit", "Dragon", "Snake", "Horse", "Goat", "Monkey", "Rooster", "Dog"};


/*
 * ????????NVIC_Configuration
 * ????  ??????RTC???��?????��???????1??????????0
 * ????  ????
 * ???  ????
 * ????  ????????
 */
void RTC_NVIC_Config(void)
{
	NVIC_InitTypeDef NVIC_InitStructure;
	
	/* Configure one bit for preemption priority */
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
	
	/* Enable the RTC Interrupt */
	NVIC_InitStructure.NVIC_IRQChannel = RTC_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_Init(&NVIC_InitStructure);
}


/*
 * ????????RTC_CheckAndConfig
 * ????  ????��????RTC
 * ????  ????????RTC??????????
 * ???  ????
 * ????  ????????
 */
void RTC_CheckAndConfig(struct rtc_time *tm)
{
   	/*?????????�|??????BKP_DR1????????????0xA5A5,
	  ?????????????????????????????*/
	if (BKP_ReadBackupRegister(RTC_BKP_DRX) != RTC_BKP_DATA)
	{
		printf("\r\n\r\n RTC not yet configured....");
		printf("\r\n\r\n RTC configured....");

		/* ???tm?????????RTC????? */
		Time_Adjust(tm);
		
		/*??BKP_DR1?????��?????????RTC????????*/
		BKP_WriteBackupRegister(RTC_BKP_DRX, RTC_BKP_DATA);
	}
	else
	{
		printf("\r\n No need to configure RTC....");
		
		/* ??? PWR ?? Backup ??? */
	  RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR | RCC_APB1Periph_BKP, ENABLE);
	
		/* ???????? Backup ???? */
	  PWR_BackupAccessCmd(ENABLE);
		
	  /*LSE?????????????????*/
		
#ifdef RTC_CLOCK_SOURCE_LSI		
			/* ??? LSI */
			RCC_LSICmd(ENABLE);

			/* ??? LSI ????? */
			while (RCC_GetFlagStatus(RCC_FLAG_LSIRDY) == RESET)
			{}
#endif

		/*?????????????*/
		if (RCC_GetFlagStatus(RCC_FLAG_PORRST) != RESET)
		{
		    printf("\r\n\r\n Power On Reset occurred....");
		}
		/*??????Reset??��*/
		else if (RCC_GetFlagStatus(RCC_FLAG_PINRST) != RESET)
		{
			printf("\r\n\r\n External Reset occurred....");
		}
	
		/*???????????*/
		RTC_WaitForSynchro();
		
		/*????RTC???��?*/
		RTC_ITConfig(RTC_IT_SEC, ENABLE);
		
		/*??????RTC?????��???????*/
		RTC_WaitForLastTask();
	}
	   /*????????????????????��??????????PC13*/
	#ifdef RTCClockOutput_Enable
	/* ??? PWR ?? Backup ??? */
	  RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR | RCC_APB1Periph_BKP, ENABLE);
	
	/* ???????? Backup ???? */
	  PWR_BackupAccessCmd(ENABLE);
	
	  /* ??? Tamper ???? */
	  /* ???? RTCCLK/64 ?? Tamper ????,  tamper ????????? */	
	  BKP_TamperPinCmd(DISABLE); 
	
	  /* ??? RTC ???????? Tamper ???? */
	  BKP_RTCOutputConfig(BKP_RTCOutputSource_CalibClock);
	#endif
	
	  /* ?????��??? flags */
	  RCC_ClearFlag();

}



/*
 * ????????RTC_Configuration
 * ????  ??????RTC
 * ????  ????
 * ???  ????
 * ????  ????????
 */
void RTC_Configuration(void)
{
	/* ??? PWR ?? Backup ??? */
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR | RCC_APB1Periph_BKP, ENABLE);
	
	/* ???????? Backup ???? */
	PWR_BackupAccessCmd(ENABLE);
	
	/* ??�� Backup ???? */
	BKP_DeInit();
	
//????????????????????bsp_rtc.h??????��	
//???????????????��????????????
//??????????????????????????????????????????	
#ifdef 	RTC_CLOCK_SOURCE_LSE
	/* ??? LSE */
	RCC_LSEConfig(RCC_LSE_ON);
	
	/* ??? LSE ????? */
	while (RCC_GetFlagStatus(RCC_FLAG_LSERDY) == RESET)
	{}
	
	/* ??? LSE ??? RTC ???? */
	RCC_RTCCLKConfig(RCC_RTCCLKSource_LSE);
	
	/* ??? RTC ??? */
	RCC_RTCCLKCmd(ENABLE);
	
	/* ??? RTC ????? ???
	 * ???RTC???????????????????????????????
	 */
	RTC_WaitForSynchro();
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
	
	/* ??? RTC ???��? */
	RTC_ITConfig(RTC_IT_SEC, ENABLE);
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
	
	/* ???? RTC ???: ? RTC ?????1s  */
	/* RTC period = RTCCLK/RTC_PR = (32.768 KHz)/(32767+1) = 1HZ */
	RTC_SetPrescaler(32767); 
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
	
#else

	/* ??? LSI */
	RCC_LSICmd(ENABLE);

	/* ??? LSI ????? */
	while (RCC_GetFlagStatus(RCC_FLAG_LSIRDY) == RESET)
	{}
	
	/* ??? LSI ??? RTC ???? */
	RCC_RTCCLKConfig(RCC_RTCCLKSource_LSI);
	
	/* ??? RTC ??? */
	RCC_RTCCLKCmd(ENABLE);
	
	/* ??? RTC ????? ???
	 * ???RTC???????????????????????????????
	 */
	RTC_WaitForSynchro();
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
	
	/* ??? RTC ???��? */
	RTC_ITConfig(RTC_IT_SEC, ENABLE);
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
	
	/* ???? RTC ???: ? RTC ?????1s ,LSI??40KHz */
	/* RTC period = RTCCLK/RTC_PR = (40 KHz)/(40000-1+1) = 1HZ */	
	RTC_SetPrescaler(40000-1); 
	
	/* ???????? RTC ???????? */
	RTC_WaitForLastTask();
#endif
	
}


#if 0
/*
 * ????????Time_Regulate_Get
 * ????  ???????????????????????
 *         ????????????????��??RTC ??????????��?
 * ????  ????????RTC??????????
 * ???  ????????????????????????????????????
 */
void Time_Regulate_Get(struct rtc_time *tm)
{
	  uint32_t temp_num = 0;
		uint8_t day_max=0 ;

	  printf("\r\n=========================???????==================");
		
	  do 
	  {
			printf("\r\n  ?????????(Please Set Years),??��[1970~2038]????????????????:");
			scanf("%d",&temp_num);
			if(temp_num <1970 || temp_num >2038)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
					  
			}
			else
			{	  
				printf("\n\r  ?????????: %d\n\r", temp_num);

				tm->tm_year = temp_num;
				break;
			}
	  }while(1);


	 do 
	  {
			printf("\r\n  ???????��?(Please Set Months):??��[1~12]????????????????:");
			scanf("%d",&temp_num);
			if(temp_num <1 || temp_num >12)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
					  
			}
			else
			{	  
				printf("\n\r  ?��???????: %d\n\r", temp_num);

				tm->tm_mon = temp_num;
				break;
			}
	  }while(1);
		
		/*?????��???????????*/
		switch(tm->tm_mon)
			{
				case 1:
				case 3:
				case 5:
				case 7:
				case 8:
				case 10:
				case 12:					
						day_max = 31;
					break;
				
				case 4:
				case 6:
				case 9:
				case 11:
						day_max = 30;
					break;
				
				case 2:					
				     /*????????*/
						if((tm->tm_year%4==0) &&
							 ((tm->tm_year%100!=0) || (tm->tm_year%400==0)) &&
							 (tm->tm_mon>2)) 
								{
									day_max = 29;
								} else 
								{
									day_max = 28;
								}
					break;			
			}

		do 
	  {				
			printf("\r\n  ??????????(Please Set Months),??��[1~%d]????????????????:",day_max);
			scanf("%d",&temp_num);
			
			if(temp_num <1 || temp_num >day_max)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
			}
			else
			{
				printf("\n\r  ??????????: %d\n\r", temp_num);

				tm->tm_mday = temp_num;
				break;
			}
	  }while(1);
		
		do 
	  {				
			printf("\r\n  ?????????(Please Set Hours),??��[0~23]????????????????:");
			scanf("%d",&temp_num);
			
			if( temp_num >23)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
			}
			else
			{
				printf("\n\r  ?????????: %d\n\r", temp_num);

				tm->tm_hour = temp_num;
				break;
			}
	  }while(1);

		do 
	  {				
			printf("\r\n  ?????????(Please Set Minutes),??��[0~59]????????????????:");
			scanf("%d",&temp_num);
			
			if( temp_num >59)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
			}
			else
			{
				printf("\n\r  ??????????: %d\n\r", temp_num);

				tm->tm_min = temp_num;
				break;
			}
	  }while(1);

		do 
	  {				
			printf("\r\n  ??????????(Please Set Seconds),??��[0~59]????????????????:");
			scanf("%d",&temp_num);
			
			if( temp_num >59)
			{
				printf("\r\n ?????????????:%d???????????",temp_num);
			}
			else
			{
				printf("\n\r  ??????????: %d\n\r", temp_num);

				tm->tm_sec = temp_num;
				break;
			}
	  }while(1);

}
#endif
/*
 * ????????Time_Show
 * ????  ????????????
 * ????  ????
 * ???  ????
 * ????  ????????
 */ 
void Time_Show(struct rtc_time *tm)
{	 
	  /* Infinite loop */
	  while (1)
	  {
	    /* ???1s */
	    if (TimeDisplay == 1)
	    {
				/* Display current time */
	      Time_Display( RTC_GetCounter(),tm); 		  
	      TimeDisplay = 0;
	    }
	  }
}


/*
 * ????????Time_Adjust
 * ????  ????????
 * ????  ????????RTC?????????????????
 * ???  ????
 * ????  ????????
 */
void Time_Adjust(struct rtc_time *tm)
{
	
			/* RTC ???? */
		RTC_Configuration();

	  /* ??????????��?????? */
	  RTC_WaitForLastTask();
		  
	  /* ???????? */
	  GregorianDay(tm);

	  /* ???????????????��??RTC????????? */
	  RTC_SetCounter(mktimev(tm)-TIME_ZOOM);

	  /* ??????????��?????? */
	  RTC_WaitForLastTask();
}

/*
 * ????????Time_Display
 * ????  ????????????
 * ????  ??-TimeVar RTC?????????��? s
 * ???  ????
 * ????  ?????????
 */	
void Time_Display(uint32_t TimeVar,struct rtc_time *tm)
{
	   static uint32_t FirstDisplay = 1;
	   uint32_t BJ_TimeVar;
	   uint8_t str[200]; // ????????  	

	   /*  ??????????????????*/
	   BJ_TimeVar =TimeVar + TIME_ZOOM;

	   to_tm(BJ_TimeVar, tm);/*????????????????????*/	
	
	  if((!tm->tm_hour && !tm->tm_min && !tm->tm_sec)  || (FirstDisplay))
	  {
	      
	      GetChinaCalendar((u16)tm->tm_year, (u8)tm->tm_mon, (u8)tm->tm_mday, str);	
					printf("\r\n new calendar%0.2d%0.2d,%0.2d,%0.2d", str[0], str[1], str[2],  str[3]);

	      FirstDisplay = 0;
	  }	 	  	

	  /* ???????????????? */
	  printf(" UNIX timestamp = %d current time: %dyear(%syear) %dmonth %dday (week%s)  %0.2d:%0.2d:%0.2d\r",TimeVar,
	                    tm->tm_year, en_zodiac_sign[(tm->tm_year-3)%12], tm->tm_mon, tm->tm_mday, 
	                    en_WEEK_STR[tm->tm_wday], tm->tm_hour, 
	                    tm->tm_min, tm->tm_sec);
		
#ifdef  USE_LCD_DISPLAY

		//????
		sprintf((char *)str," UNIX TimeStamp = %d ",TimeVar);

		ILI9341_DispStringLine_EN(LINE(3),(char*)str);
		
		//????
		sprintf((char *)str," Date: %d-%d-%d       ",
																						tm->tm_year, 
																						tm->tm_mon,
																						tm->tm_mday);
		ILI9341_DispStringLine_EN(LINE(5),(char*)str);
		
		//??��
		sprintf((char *)str," Chinese %s year      ",en_zodiac_sign[(tm->tm_year-3)%12]);
		
		ILI9341_DispStringLine_EN(LINE(6),(char*)str);
		
		//????
		sprintf((char *)str," %s                  ",en_WEEK_STR[tm->tm_wday]);
		
		ILI9341_DispStringLine_EN(LINE(7),(char*)str);
		
		//???
		sprintf((char *)str," Time:  %0.2d:%0.2d:%0.2d",
																						tm->tm_hour, 									
																						tm->tm_min, 
																						tm->tm_sec);
		
		ILI9341_DispStringLine_EN(LINE(8),(char*)str);
#endif
		
}


/************************END OF FILE***************************************/
